"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var r=0,n=new Array(e.length);r<e.length;r++)n[r]=e[r];return n}}var http=require("http"),_require=require("socket.io"),Server=_require.Server,mongoose=require("mongoose"),httpServer=http.createServer(),io=new Server(httpServer,{cors:{origin:"http://localhost:3000",methods:["GET","POST"]}}),db=require("./models"),Chat=db.chats,ChatUser=db.chatusers;io.on("connection",function(s){console.log("a user connected"),s.on("format",function(r){var n,t,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.walletAddress,console.log("wallet: ",n),a={logined:!(t={walletAddress:n})},e.next=6,regeneratorRuntime.awrap(ChatUser.updateOne(t,a));case 6:e.sent;case 7:case"end":return e.stop()}})}),s.on("wallet",function(r){var n,s,t,a,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.walletAddress,e.next=3,regeneratorRuntime.awrap(ChatUser.findOne({walletAddress:n}));case 3:if(!(s=e.sent)){e.next=20;break}if(0<s.unreadmsg.length)return s.unreadmsg.map(function(r){var n,t,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(Chat.findOne({id:r}));case 2:if(null!=(n=e.sent)){e.next=6;break}e.next=14;break;case 6:return t={id:r},a={readed:[].concat(_toConsumableArray(n.readed),[s.username])},e.next=10,regeneratorRuntime.awrap(Chat.updateOne(t,a));case 10:return e.sent,e.next=13,regeneratorRuntime.awrap(Chat.findOne({id:r}));case 13:e.sent;case 14:case"end":return e.stop()}})}),t={username:s.username},a={unreadmsg:[]},e.next=11,regeneratorRuntime.awrap(ChatUser.updateOne(t,a));e.next=20;break;case 11:return e.sent,e.next=14,regeneratorRuntime.awrap(ChatUser.findOne({username:s.username}));case 14:return e.sent,e.next=17,regeneratorRuntime.awrap(Chat.find({}));case 17:o=e.sent,io.emit("checked",o),io.emit("Alert",{walletAddress:s.walletAddress,alert:0});case 20:case"end":return e.stop()}})}),s.on("login",function(r){var n,a,t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log(r),e.next=3,regeneratorRuntime.awrap(ChatUser.findOne({username:r.username}));case 3:if(n=e.sent,console.log("existingUser:",n),!n){e.next=10;break}"user is already existed.",io.to(s.id).emit("userexist","user is already existed."),e.next=22;break;case 10:return(a=new ChatUser({id:s.id,username:r.username,walletAddress:r.walletAddress,avatar:r.avatarUrl,logined:!0,unreadmsg:[]})).save(),io.to(s.id).emit("login",a),e.next=15,regeneratorRuntime.awrap(Chat.find({}));case 15:return e.sent.map(function(r){var n,t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n={id:r.id},t={readed:[a.username]},e.next=4,regeneratorRuntime.awrap(Chat.updateOne(n,t));case 4:e.sent;case 5:case"end":return e.stop()}})}),e.next=19,regeneratorRuntime.awrap(Chat.find({}));case 19:t=e.sent,console.log("readed",t),io.emit("checked",t);case 22:case"end":return e.stop()}})}),s.on("logout",function(r){var n,t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n={username:r.username},t={logined:r.logined},e.next=4,regeneratorRuntime.awrap(ChatUser.updateOne(n,t));case 4:e.sent;case 5:case"end":return e.stop()}})}),s.on("message",function(t){console.log("New message:",t);var a=[],s=mongoose.Types.ObjectId();ChatUser.aggregate([{$match:{logined:!0}},{$project:{_id:0,username:1,avatar:2}}],function(e,r){if(!e){r.map(function(e,r){e.username!=t.username&&a.push(e.username)});var n=new Chat({id:s,userName:t.username,avatar:t.avatar,message:t.message,timestamp:new Date,readed:a});n.save(),io.emit("message",n)}}),ChatUser.aggregate([{$match:{logined:!1}},{$project:{_id:0,username:1,unreadmsg:2}}],function(e,r){e||r.map(function(r){var n,t,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n={username:r.username},t={unreadmsg:[].concat(_toConsumableArray(r.unreadmsg),[s])},e.next=4,regeneratorRuntime.awrap(ChatUser.updateOne(n,t));case 4:return e.sent,e.next=7,regeneratorRuntime.awrap(ChatUser.findOne({username:r.username}));case 7:a=e.sent,io.emit("Alert",{walletAddress:a.walletAddress,alert:a.unreadmsg.length}),console.log("up",a);case 10:case"end":return e.stop()}})})})}),s.on("disconnect",function(){console.log("Client disconnected")})});var PORT=8080;httpServer.listen(PORT,function(){console.log("Socket.IO server is running on port ".concat(PORT))});
//# sourceMappingURL=socketServer.min.js.map
